# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

## å•é¡Œ

ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ã§ã€Œãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹å ´åˆã€Supabaseã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## ğŸš¨ é‡è¦: SQLã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ

ã‚‚ã—ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆï¼š
```
ERROR: 42703: column "user_id" does not exist
```

**æœ€æ–°ç‰ˆã®`complete-setup.sql`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„**ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒªã‚·ãƒ¼ã®å•é¡Œã‚’ä¿®æ­£æ¸ˆã¿ï¼‰

ğŸ‘‰ è©³ç´°ã¯ [QUICK_FIX_GUIDE.md](QUICK_FIX_GUIDE.md) ã‚’å‚ç…§

## è§£æ±ºæ–¹æ³•

ä»¥ä¸‹ã®æ‰‹é †ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆã—ã¾ã™ã€‚

### ã‚¹ãƒ†ãƒƒãƒ—1: Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹

1. [Supabase Dashboard](https://supabase.com/dashboard) ã‚’é–‹ã
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‹ã‚‰è©²å½“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ
3. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ **SQL Editor** ã‚’ã‚¯ãƒªãƒƒã‚¯

### ã‚¹ãƒ†ãƒƒãƒ—2: SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ

1. **New Query** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. `supabase/sql/complete-setup.sql` ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å…¨ã¦ã‚³ãƒ”ãƒ¼
3. SQL Editorã«ãƒšãƒ¼ã‚¹ãƒˆ
4. å³ä¸‹ã® **Run** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

**å®Ÿè¡Œã™ã‚‹SQL**: `/supabase/sql/complete-setup.sql`

### ã‚¹ãƒ†ãƒƒãƒ—3: å®Ÿè¡Œçµæœã‚’ç¢ºèª

**æˆåŠŸã—ãŸå ´åˆ**:
```
Success. No rows returned
```

**ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ**:
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
- æ—¢ã«ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å•é¡Œãªã—ï¼ˆ`already exists`ã‚¨ãƒ©ãƒ¼ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚’ç¢ºèª

1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ **Table Editor** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼š
   - âœ… `profiles` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
   - âœ… `albums` - ã‚¢ãƒ«ãƒãƒ 
   - âœ… `photos` - å†™çœŸ
   - âœ… `shares` - å…±æœ‰ãƒªãƒ³ã‚¯
   - âœ… `album_members` - ã‚¢ãƒ«ãƒãƒ ãƒ¡ãƒ³ãƒãƒ¼
   - âœ… `comments` - ã‚³ãƒ¡ãƒ³ãƒˆ
   - âœ… `photo_tags` - å†™çœŸã‚¿ã‚°

### ã‚¹ãƒ†ãƒƒãƒ—5: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆã‚’ç¢ºèª

1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ **Storage** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. `photos` ãƒã‚±ãƒƒãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
3. ã‚‚ã—ä½œæˆã•ã‚Œã¦ã„ãªã„å ´åˆ:
   - **Create a new bucket** ã‚’ã‚¯ãƒªãƒƒã‚¯
   - Name: `photos`
   - Public bucket: **ã‚ªãƒ•**ï¼ˆãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ï¼‰
   - **Create bucket** ã‚’ã‚¯ãƒªãƒƒã‚¯

### ã‚¹ãƒ†ãƒƒãƒ—6: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ

1. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆF5ï¼‰
2. ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ã§æƒ…å ±ã‚’å…¥åŠ›
3. ã€Œå®Œäº†ã—ã¦ã‚¢ãƒ«ãƒãƒ ã‚’å§‹ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
4. **æœŸå¾…çµæœ**: ã‚¢ãƒ«ãƒãƒ ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: relation "public.profiles" does not exist

**åŸå› **: ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
1. ä¸Šè¨˜ã®ã‚¹ãƒ†ãƒƒãƒ—2ã‚’å®Ÿè¡Œ
2. SQLå®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ãªã„ã‹ç¢ºèª

### ã‚¨ãƒ©ãƒ¼: permission denied for table profiles

**åŸå› **: RLSï¼ˆRow Level Securityï¼‰ãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
1. Table Editor > `profiles` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–‹ã
2. å³ä¸Šã® **...** ãƒ¡ãƒ‹ãƒ¥ãƒ¼ > **Edit table** > **Enable RLS** ã‚’ç¢ºèª
3. ã‚‚ã†ä¸€åº¦ `complete-setup.sql` ã‚’å®Ÿè¡Œ

### ã‚¨ãƒ©ãƒ¼: duplicate key value violates unique constraint

**åŸå› **: æ—¢ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒå­˜åœ¨ã™ã‚‹

**è§£æ±ºæ–¹æ³•**:
1. Table Editor > `profiles` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–‹ã
2. è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œã‚’å‰Šé™¤
3. ã‚‚ã†ä¸€åº¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šã‚’è©¦ã™

### ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã—ãªã„å ´åˆ

**ãƒ‡ãƒãƒƒã‚°æ‰‹é †**:

1. ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚’é–‹ã
2. **Console** ã‚¿ãƒ–ã‚’ç¢ºèª
3. ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’æ¢ã™ï¼š
   ```
   ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆè©³ç´°ï¼‰: { message: "...", ... }
   ```
4. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç¢ºèª

## è©³ç´°ãªè¨­å®šå†…å®¹

### profiles ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

| ã‚«ãƒ©ãƒ å | å‹ | èª¬æ˜ |
|---------|-----|------|
| user_id | uuid | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¸»ã‚­ãƒ¼ã€auth.usersã¸ã®å¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| display_name | text | è¡¨ç¤ºå |
| avatar_url | text | ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®URL |
| bio | text | è‡ªå·±ç´¹ä»‹ |
| created_at | timestamptz | ä½œæˆæ—¥æ™‚ |
| updated_at | timestamptz | æ›´æ–°æ—¥æ™‚ |

### RLS ãƒãƒªã‚·ãƒ¼

`profiles` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯ä»¥ä¸‹ã®RLSãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼š

- **SELECT**: è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿å‚ç…§å¯èƒ½
- **INSERT**: è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿ä½œæˆå¯èƒ½
- **UPDATE**: è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿æ›´æ–°å¯èƒ½
- **DELETE**: è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿å‰Šé™¤å¯èƒ½

ã“ã‚Œã«ã‚ˆã‚Šã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¦‹ãŸã‚Šå¤‰æ›´ã—ãŸã‚Šã§ããªã„ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

## æ‰‹å‹•ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹å ´åˆ

ã‚‚ã—SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡ŒãŒã†ã¾ãã„ã‹ãªã„å ´åˆã€ä»¥ä¸‹ã®æœ€å°é™ã®SQLã§`profiles`ãƒ†ãƒ¼ãƒ–ãƒ«ã ã‘ã‚’ä½œæˆã§ãã¾ã™ï¼š

```sql
-- profilesãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
CREATE TABLE public.profiles (
  user_id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name text,
  avatar_url text,
  bio text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY profiles_all ON public.profiles
FOR ALL
USING (user_id = auth.uid())
WITH CHECK (user_id = auth.uid());
```

## ç¢ºèªç”¨SQL

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ­£ã—ãã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹SQLï¼š

```sql
-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’ç¢ºèª
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;

-- profilesãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ ã‚’ç¢ºèª
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'public' 
  AND table_name = 'profiles'
ORDER BY ordinal_position;

-- RLSãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèª
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename = 'profiles';

-- è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç¢ºèªï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œï¼‰
SELECT * FROM profiles WHERE user_id = auth.uid();
```

## å‚è€ƒãƒªãƒ³ã‚¯

- [Supabase Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [Supabase SQL Editor](https://supabase.com/docs/guides/database/overview)
- [PostgreSQL ãƒ‡ãƒ¼ã‚¿å‹](https://www.postgresql.org/docs/current/datatype.html)

